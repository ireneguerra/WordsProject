name: Execute Terraform and Java Classes

on:
  workflow_dispatch:
    inputs:
      AWS_ACCESS_KEY_ID:
        description: "AWS Access Key ID"
        required: true
      AWS_SECRET_ACCESS_KEY:
        description: "AWS Secret Access Key"
        required: true
      AWS_SESSION_TOKEN:
        description: "AWS Session Token"
        required: true

jobs:
  execute-workflow:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.7

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        aws-access-key-id: ${{ github.event.inputs.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ github.event.inputs.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ github.event.inputs.AWS_SESSION_TOKEN }}
        aws-region: us-east-1

    - name: Validate Terraforms Directory
      shell: pwsh
      run: |
        if (!(Test-Path -Path terraforms)) {
          Write-Error "Directory 'terraforms' does not exist."
          exit 1
        }

    - name: Terraform Init
      shell: pwsh
      working-directory: terraforms
      run: terraform init -input=false -no-color

    - name: Terraform Plan
      shell: pwsh
      working-directory: terraforms
      run: terraform plan -no-color

    - name: Terraform Apply
      shell: pwsh
      working-directory: terraforms
      run: terraform apply -auto-approve -no-color

    - name: Run BookCrawler JAR
      shell: pwsh
      run: java -jar BookCrawler/target/BookCrawler.jar

    - name: Run WordCounterDatamart JAR
      shell: pwsh
      run: java -jar WordCounterDatamart/target/WordCounterDatamart.jar

    - name: Run WordsGraph JAR
      shell: pwsh
      run: java -jar WordsGraph/target/WordsGraph.jar

    - name: Run APIGraph JAR
      shell: pwsh
      run: java -jar APIGraph/target/APIGraph.jar
